<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Creador de Diagramas</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #f0f0f0;
            overflow: hidden;
        }
        
        #diagrama {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #2d2d2d;
            overflow: hidden;
            cursor: default;
            transition: background-color 0.3s ease;
        }
        
        /* Canvas para las l√≠neas de conexi√≥n */
        #conexiones-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .nota {
            position: absolute;
            width: 200px;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #444;
            background-color: #333;
            color: #f0f0f0;
            resize: none;
            outline: none;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            z-index: 2;
        }
        
        .nota:hover {
            border-color: #666;
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        .nota.seleccionada-conexion {
            border-color: #4CAF50;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }
        
        .nota.imagen:hover {
            border-color: #66bb6a;
        }

        .nota.imagen {
            padding: 0px;
            overflow: hidden;
            background: transparent;
            border: 2px solid #4CAF50;
            min-width: 150px;
            min-height: 150px;
            resize: both;
            position: absolute;
        }

        /* Mejora para el resize manual */
.nota.imagen::after {
    content: '‚Üò';
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: #4CAF50;
    color: white;
    border: 2px solid #fff;
    border-radius: 4px;
    cursor: se-resize;
    z-index: 3;
    pointer-events: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}
        .nota.imagen:hover::after {
            background: #45a049;
        }

        .nota.imagen .contenido-imagen {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            position: relative;
            padding: 0;
        }

        .nota.imagen img {
    width: 100%;           /* ‚Üê Asegura que ocupe todo el ancho */
    height: 100%;          /* ‚Üê Asegura que ocupe toda la altura */
    object-fit: fill;   /* ‚Üê Mantiene proporciones */
    display: block;
    pointer-events: none;
    -webkit-user-drag: none;
    user-select: none;
    transition: transform 0.1s ease;
}

        /* Permitir redimensionar solo im√°genes */
        .nota.imagen {
            overflow: hidden;
        }

        .nota.imagen::-webkit-resizer {
            background-color: #4CAF50;
            border-radius: 2px;
            width: 12px;
            height: 12px;
        }

        /* TACHUELA M√ÅS SIMPLE - SIN BLOQUEO */
        .tachuela {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: box-shadow 0.2s, transform 0.2s;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .tachuela:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transform: scale(1.1);
        }
        
        .tachuela.seleccionada-conexion {
            border-color: #4CAF50;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }
        
        .tachuela .boton-menu {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #444;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .tachuela:hover .boton-menu {
            opacity: 1;
        }
        
        /* MEN√ö SIMPLIFICADO PARA TACHUELAS - SOLO CLONAR Y ELIMINAR */
        .tachuela .menu-desplegable {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            min-width: 120px;
        }
        
        .tachuela .menu-desplegable button {
            display: block;
            width: 100%;
            margin: 4px 0;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }
        
        .tachuela .menu-desplegable .btn-clonar {
            background: #4CAF50;
            color: white;
        }
        
        .tachuela .menu-desplegable .btn-eliminar {
            background: #ff4444;
            color: white;
        }
        
        .tachuela.bloqueada {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .nota.bloqueada {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .nota.bloqueada::after,
        .tachuela.bloqueada::after {
            content: "üîí";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff4444;
            color: white;
            padding: 2px 4px;
            border-radius: 50%;
            font-size: 10px;
            z-index: 100;
        }
        
        .contenido-nota {
            min-height: 70px;
            outline: none;
            cursor: pointer;
            pointer-events: none;
            white-space: pre-wrap;
            word-break: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-direction: column;
        }
        
        @media (hover: hover) and (pointer: fine) {
            .contenido-nota {
                pointer-events: auto;
                cursor: text;
            }
        }
        
        .boton-menu {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: #444;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: background-color 0.2s;
            opacity: 0.7;
        }
        
        .nota:hover .boton-menu {
            opacity: 1;
        }
        
        .boton-menu:hover {
            background-color: #555;
        }
        
        .menu-desplegable {
            position: absolute;
            bottom: 40px;
            right: 5px;
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            min-width: 170px;
            overflow: visible;
        }
        
        .menu-desplegable label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
            margin-top: 10px;
        }
        
        .menu-desplegable button, .menu-desplegable input {
            display: block;
            width: 100%;
            margin: 6px 0;
            padding: 8px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .menu-desplegable button:hover {
            opacity: 0.9;
        }
        
        .color-picker {
            height: 40px;
            padding: 3px;
            background: transparent;
            cursor: pointer;
        }
        
        .btn-clonar {
            background: #4CAF50;
            color: white;
        }
        
        .btn-bloquear {
            background: #FF9800;
            color: white;
        }
        
        .btn-eliminar {
            background: #ff4444;
            color: white;
        }
        
        .btn-eliminar:hover {
            background: #cc0000;
        }
        
        /* BOT√ìN PARA MOSTRAR/OCULTAR UI */
        #btn-toggle-ui {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: #444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s;
        }
        
        #btn-toggle-ui:hover {
            background: #555;
            transform: scale(1.05);
        }
        
        #btn-toggle-ui.oculta {
            background: #666;
        }
        
        /* Controles principales - OCULTABLES */
        .control-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .control-panel.oculta {
            opacity: 0;
            transform: translateX(-100%);
            pointer-events: none;
        }
        
        .control-btn {
            background: #444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;
        }
        
        .control-btn:hover {
            background: #555;
            transform: translateY(-2px);
        }
        
        .control-btn.activo {
            background: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }
        
        .control-btn:nth-child(1) { background: #9C27B0; } /* Fondo */
        .control-btn:nth-child(1):hover { background: #7b1fa2; }
        .control-btn:nth-child(2) { background: #4CAF50; } /* Nueva Nota */
        .control-btn:nth-child(2):hover { background: #45a049; }
        .control-btn:nth-child(3) { background: #FF9800; } /* A√±adir Imagen */
        .control-btn:nth-child(3):hover { background: #f57c00; }
        .control-btn:nth-child(4) { background: #2196F3; } /* Conectar */
        .control-btn:nth-child(4):hover { background: #0b7dda; }
        .control-btn:nth-child(5) { background: #f44336; } /* Limpiar */
        .control-btn:nth-child(5):hover { background: #d32f2f; }
        .control-btn:nth-child(6) { background: #FF5722; } /* Firebase */
        .control-btn:nth-child(6):hover { background: #e64a19; }
        .control-btn:nth-child(7) { background: #FFC107; color: #333; } /* A√±adir Tachuela */
        .control-btn:nth-child(7):hover { background: #FFB300; }
        
        /* Panel de control de color de conexi√≥n - OCULTABLE */
        .control-conexion {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .control-conexion.oculta {
            opacity: 0;
            transform: translateX(100%);
            pointer-events: none;
        }
        
        .color-conexion-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #444;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .color-conexion-btn:hover {
            transform: scale(1.1);
            border-color: #fff;
        }
        
        .color-conexion-btn.activo {
            border-color: #FFD700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.5);
        }
        
        #selector-color-fondo {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 60px;
            height: 60px;
            padding: 5px;
            background: #333;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-contenido {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid #444;
        }
        
        .modal-contenido h3 {
            margin-bottom: 20px;
            color: #f0f0f0;
            font-size: 24px;
            text-align: center;
        }
        
        /* Modal de Firebase - Carousel */
        .modal-firebase .modal-contenido {
            max-width: 500px;
            padding: 20px;
        }
        
        .carousel-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .slot-item {
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            transition: background-color 0.2s;
        }
        
        .slot-item:hover {
            background: #3a3a3a;
        }
        
        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .slot-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #f0f0f0;
        }
        
        .slot-fecha {
            font-size: 12px;
            color: #888;
        }
        
        .slot-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .slot-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        
        .slot-btn:hover {
            opacity: 0.9;
        }
        
        .btn-sobrescribir {
            background: #FF9800;
            color: white;
        }
        
        .btn-cargar {
            background: #4CAF50;
            color: white;
        }
        
        .btn-borrar {
            background: #f44336;
            color: white;
        }
        
        .btn-nuevo-slot {
            background: #2196F3;
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            font-size: 16px;
        }
        
        .modal-nuevo-slot .modal-contenido {
            max-width: 400px;
        }
        
        .input-grupo {
            margin: 20px 0;
        }
        
        .input-grupo label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }
        
        .input-grupo input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
            color: #f0f0f0;
            font-size: 16px;
        }
        
        .input-grupo input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .preview-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }
        
        .preview-area {
            background: #1a1a1a;
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preview-imagen {
            max-width: 100%;
            max-height: 250px;
            object-fit: contain;
            display: none;
        }
        
        .preview-placeholder {
            color: #888;
            font-size: 16px;
        }
        
        .control-imagen {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .control-grupo {
            margin-bottom: 20px;
        }
        
        .control-grupo label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #555;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .info-size {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: #888;
        }
        
        .warning {
            background: #ff9800;
            color: #333;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .modal-botones {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-cancel {
            background: #666;
            color: white;
        }
        
        /* Textarea del modal de texto */
        #texto-modal {
            width: 100%;
            height: 300px;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 8px;
            resize: vertical;
            background: #333;
            color: #f0f0f0;
            font-size: 16px;
            line-height: 1.5;
            font-family: Arial, sans-serif;
        }
        
        #texto-modal:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        /* Indicador de modo conexi√≥n */
        .modo-conexion-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: none;
        }
        
        /* Estilos para m√≥viles */
        @media (max-width: 768px) {
            .nota {
                width: 180px;
                min-height: 90px;
                padding: 12px;
            }
            
            .tachuela {
                width: 25px;
                height: 25px;
                font-size: 14px;
            }
            
            #btn-toggle-ui {
                top: 5px;
                left: 5px;
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .control-panel {
                top: 60px;
                left: 15px;
                right: 15px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .control-conexion {
                top: 60px;
                right: 15px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .control-btn {
                min-width: 140px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .color-conexion-btn {
                width: 30px;
                height: 30px;
            }
            
            #selector-color-fondo {
                top: 130px;
                left: 15px;
                width: 50px;
                height: 50px;
            }
            
            .modal-contenido {
                padding: 20px;
                width: 95%;
                margin: 10px;
            }
            
            .preview-area {
                min-height: 200px;
            }
            
            #preview-imagen {
                max-height: 180px;
            }
            
            .modal-botones {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-btn {
                width: 100%;
                padding: 15px;
            }
            
            .slot-actions {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .control-btn {
                min-width: calc(50% - 5px);
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .control-panel {
                gap: 5px;
            }
        }
        
        /* Estilos para el modal de confirmaci√≥n de eliminaci√≥n */
        .modal-eliminar .modal-contenido {
            max-width: 400px;
        }
        
        .modal-limpiar .modal-contenido {
            max-width: 400px;
        }
        
        .confirmacion-texto {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: #f0f0f0;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #2196F3;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mensaje-estado {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .mensaje-exito {
            background: #4CAF50;
            color: white;
        }
        
        .mensaje-error {
            background: #f44336;
            color: white;
        }

        /* Quitar el bot√≥n de bloqueo de proporciones del men√∫ ya que no lo necesitamos */
.menu-desplegable .btn-lock-aspect {
    display: none;
}
    </style>
</head>
<body>
    <div id="diagrama">
        <canvas id="conexiones-canvas"></canvas>
    </div>
    
    <!-- BOT√ìN PARA MOSTRAR/OCULTAR UI -->
    <button id="btn-toggle-ui" title="Mostrar/Ocultar controles">üëÅÔ∏è</button>
    
    <!-- Indicador de modo conexi√≥n -->
    <div id="modo-conexion-info" class="modo-conexion-info">
        üîó Modo Conexi√≥n Activo - Selecciona dos objetos para conectarlos
    </div>
    
    <!-- Panel de controles -->
    <div class="control-panel">
        <button id="btn-color-fondo" class="control-btn">üé® Color Fondo</button>
        <button id="btn-anadir" class="control-btn">+ Nueva Nota</button>
        <button id="btn-anadir-imagen" class="control-btn">üñºÔ∏è A√±adir Imagen</button>
        <button id="btn-anadir-tachuela" class="control-btn">üìå A√±adir Tachuela</button>
        <button id="btn-conectar" class="control-btn">üîó Conectar</button>
        <button id="btn-limpiar" class="control-btn">üóëÔ∏è Limpiar</button>
        <button id="btn-firebase" class="control-btn">üî• Firebase</button>
    </div>
    
    <!-- Panel de control para color de conexi√≥n -->
    <div class="control-conexion">
        <div class="color-conexion-btn" style="background-color: #4CAF50;" data-color="#4CAF50" title="Verde"></div>
        <div class="color-conexion-btn" style="background-color: #2196F3;" data-color="#2196F3" title="Azul"></div>
        <div class="color-conexion-btn" style="background-color: #f44336;" data-color="#f44336" title="Rojo"></div>
        <div class="color-conexion-btn" style="background-color: #FF9800;" data-color="#FF9800" title="Naranja"></div>
        <div class="color-conexion-btn" style="background-color: #9C27B0;" data-color="#9C27B0" title="Morado"></div>
        <div class="color-conexion-btn" style="background-color: #000000;" data-color="#000000" title="Negro"></div>
        <div class="color-conexion-btn" style="background-color: #FFFFFF;" data-color="#FFFFFF" title="Blanco"></div>
    </div>
    
    <input type="color" id="selector-color-fondo" value="#2d2d2d">
    
    <!-- Modal de edici√≥n de texto -->
    <div id="modal-texto" class="modal">
        <div class="modal-contenido">
            <h3>Editar Nota</h3>
            <textarea id="texto-modal" placeholder="Escribe el contenido de la nota aqu√≠..."></textarea>
            <div class="modal-botones">
                <button id="cancelar-texto" class="modal-btn btn-cancel">Cancelar</button>
                <button id="guardar-texto" class="modal-btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de ajuste de imagen -->
    <div id="modal-imagen" class="modal">
        <div class="modal-contenido">
            <h3>Ajustar Imagen</h3>
            
            <div class="preview-container">
                <div class="preview-area">
                    <img id="preview-imagen" alt="Vista previa">
                    <div id="preview-placeholder" class="preview-placeholder">
                        Selecciona una imagen para ver la vista previa
                    </div>
                </div>
                
                <div class="control-imagen">
                    <div class="control-grupo">
                        <label for="input-imagen">Seleccionar imagen:</label>
                        <input type="file" id="input-imagen" accept="image/*" class="modal-btn btn-secondary">
                    </div>
                    
                    <div id="warning-size" class="warning" style="display: none;">
                        ‚ö†Ô∏è La imagen es muy grande (m√°s de 2MB). Se recomienda reducir la calidad.
                    </div>
                    
                    <div class="control-grupo">
                        <label for="calidad-imagen">Calidad de compresi√≥n: <span id="valor-calidad">80</span>%</label>
                        <input type="range" id="calidad-imagen" min="1" max="100" value="80">
                        <div class="info-size">
                            <span>Baja calidad (m√°s peque√±a)</span>
                            <span>Alta calidad (m√°s grande)</span>
                        </div>
                    </div>
                    
                    <div class="control-grupo">
                        <label for="tamanio-imagen">Tama√±o de visualizaci√≥n: <span id="valor-tamanio">300</span>px</label>
                        <input type="range" id="tamanio-imagen" min="100" max="500" value="300">
                        <div class="info-size">
                            <span>Peque√±o</span>
                            <span>Grande</span>
                        </div>
                    </div>
                    
                    <div class="control-grupo">
                        <label>
                            <input type="checkbox" id="lock-aspect" checked> Bloquear proporciones (mantener aspect ratio)
                        </label>
                    </div>
                    
                    <div class="info-size">
                        <div id="info-tamanio">Tama√±o aproximado: --</div>
                        <div id="info-dimensiones">Dimensiones: --</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-botones">
                <button id="cancelar-imagen" class="modal-btn btn-cancel">Cancelar</button>
                <button id="insertar-imagen" class="modal-btn btn-primary">Insertar Imagen</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Firebase -->
    <div id="modal-firebase" class="modal modal-firebase">
        <div class="modal-contenido">
            <h3>Firebase - Slots Guardados</h3>
            <div id="loading-slots" class="spinner"></div>
            <div id="carousel-slots" class="carousel-container" style="display: none;">
                <!-- Los slots se insertar√°n aqu√≠ din√°micamente -->
            </div>
            <div id="sin-slots" style="text-align: center; padding: 20px; display: none;">
                <p>No hay slots guardados. ¬°Crea uno nuevo!</p>
            </div>
            <button id="btn-nuevo-slot" class="slot-btn btn-nuevo-slot">‚ûï A√±adir como nuevo slot</button>
            <div id="mensaje-firebase" class="mensaje-estado" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Modal para nuevo slot -->
    <div id="modal-nuevo-slot" class="modal modal-nuevo-slot">
        <div class="modal-contenido">
            <h3>Nuevo Slot</h3>
            <div class="input-grupo">
                <label for="titulo-slot">T√≠tulo del slot:</label>
                <input type="text" id="titulo-slot" placeholder="Ej: Diagrama del Proyecto X" maxlength="50">
            </div>
            <div class="modal-botones">
                <button id="cancelar-nuevo-slot" class="modal-btn btn-cancel">Cancelar</button>
                <button id="guardar-nuevo-slot" class="modal-btn btn-primary">Guardar Slot</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmaci√≥n de eliminaci√≥n -->
    <div id="modal-eliminar" class="modal modal-eliminar">
        <div class="modal-contenido">
            <h3>Eliminar Elemento</h3>
            <div class="confirmacion-texto">
                ¬øEst√°s seguro de que quieres eliminar este elemento?
            </div>
            <div class="modal-botones">
                <button id="cancelar-eliminar" class="modal-btn btn-cancel">No, cancelar</button>
                <button id="confirmar-eliminar" class="modal-btn btn-danger">S√≠, eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmaci√≥n para limpiar pizarra -->
    <div id="modal-limpiar" class="modal modal-limpiar">
        <div class="modal-contenido">
            <h3>Limpiar Pizarra</h3>
            <div class="confirmacion-texto">
                ¬øEst√°s seguro de que quieres limpiar toda la pizarra?<br>
                Esta acci√≥n no se puede deshacer.
            </div>
            <div class="modal-botones">
                <button id="cancelar-limpiar" class="modal-btn btn-cancel">No, cancelar</button>
                <button id="confirmar-limpiar" class="modal-btn btn-danger">S√≠, limpiar todo</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAaEANoYE3VwANHQYJBfnfwOFoIIfrj-0A",
            authDomain: "diagrama-8042c.firebaseapp.com",
            databaseURL: "https://diagrama-8042c-default-rtdb.firebaseio.com",
            projectId: "diagrama-8042c",
            storageBucket: "diagrama-8042c.firebasestorage.app",
            messagingSenderId: "317654156127",
            appId: "1:317654156127:web:b9188d5980c62c13a1ecea"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Referencia a la base de datos
        const slotsRef = database.ref('diagramSlots');

        const diagrama = document.getElementById('diagrama');
        let conexionesCanvas = document.getElementById('conexiones-canvas');
        let ctx = conexionesCanvas.getContext('2d');
        const modoConexionInfo = document.getElementById('modo-conexion-info');
        const btnToggleUI = document.getElementById('btn-toggle-ui');
        const btnAnadir = document.getElementById('btn-anadir');
        const btnColorFondo = document.getElementById('btn-color-fondo');
        const btnAnadirImagen = document.getElementById('btn-anadir-imagen');
        const btnAnadirTachuela = document.getElementById('btn-anadir-tachuela');
        const btnConectar = document.getElementById('btn-conectar');
        const btnLimpiar = document.getElementById('btn-limpiar');
        const btnFirebase = document.getElementById('btn-firebase');
        const selectorColorFondo = document.getElementById('selector-color-fondo');
        const controlPanel = document.querySelector('.control-panel');
        const controlConexion = document.querySelector('.control-conexion');
        
        // Modales
        const modalTexto = document.getElementById('modal-texto');
        const modalImagen = document.getElementById('modal-imagen');
        const modalFirebase = document.getElementById('modal-firebase');
        const modalNuevoSlot = document.getElementById('modal-nuevo-slot');
        const modalEliminar = document.getElementById('modal-eliminar');
        const modalLimpiar = document.getElementById('modal-limpiar');
        
        // Elementos del modal de texto
        const textoModal = document.getElementById('texto-modal');
        const guardarTextoBtn = document.getElementById('guardar-texto');
        const cancelarTextoBtn = document.getElementById('cancelar-texto');
        
        // Elementos del modal de imagen
        const inputImagen = document.getElementById('input-imagen');
        const previewImagen = document.getElementById('preview-imagen');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const calidadImagen = document.getElementById('calidad-imagen');
        const tamanioImagen = document.getElementById('tamanio-imagen');
        const lockAspectCheckbox = document.getElementById('lock-aspect');
        const valorCalidad = document.getElementById('valor-calidad');
        const valorTamanio = document.getElementById('valor-tamanio');
        const infoTamanio = document.getElementById('info-tamanio');
        const infoDimensiones = document.getElementById('info-dimensiones');
        const warningSize = document.getElementById('warning-size');
        const cancelarImagenBtn = document.getElementById('cancelar-imagen');
        const insertarImagenBtn = document.getElementById('insertar-imagen');
        
        // Elementos del modal de Firebase
        const carouselSlots = document.getElementById('carousel-slots');
        const loadingSlots = document.getElementById('loading-slots');
        const sinSlots = document.getElementById('sin-slots');
        const btnNuevoSlot = document.getElementById('btn-nuevo-slot');
        const mensajeFirebase = document.getElementById('mensaje-firebase');
        const tituloSlotInput = document.getElementById('titulo-slot');
        const cancelarNuevoSlotBtn = document.getElementById('cancelar-nuevo-slot');
        const guardarNuevoSlotBtn = document.getElementById('guardar-nuevo-slot');
        
        // Elementos del modal de eliminaci√≥n
        const cancelarEliminarBtn = document.getElementById('cancelar-eliminar');
        const confirmarEliminarBtn = document.getElementById('confirmar-eliminar');
        
        // Elementos del modal de limpieza
        const cancelarLimpiarBtn = document.getElementById('cancelar-limpiar');
        const confirmarLimpiarBtn = document.getElementById('confirmar-limpiar');

        // Variables globales
        let notaActual = null;
        let elementoAEliminar = null;
        let slotAEliminar = null;
        let notaArrastrandose = null;
        let offset = { x: 0, y: 0 };
        let notaIdCounter = localStorage.getItem('notaIdCounter') ? parseInt(localStorage.getItem('notaIdCounter')) : 1;
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let uiVisible = localStorage.getItem('uiVisible') !== 'false'; // Por defecto visible
        
        // Variables para im√°genes
        let imagenOriginal = null;
        let imagenBase64 = null;
        let imagenTamanio = 300;
        let lockAspectRatio = true;
        
        // Variables para conexiones
        let modoConexion = false;
        let primeraSeleccionConexion = null;
        let segundaSeleccionConexion = null;
        let conexiones = JSON.parse(localStorage.getItem('conexiones')) || [];
        let colorConexion = localStorage.getItem('colorConexion') || '#4CAF50';
        
        // Colores predefinidos para tachuelas - SIMPLIFICADO
        const coloresTachuela = [
            '#FFD700', // Amarillo
            '#FF4444', // Rojo
            '#4CAF50', // Verde
            '#2196F3', // Azul
            '#9C27B0', // Morado
            '#FF9800', // Naranja
            '#00BCD4', // Celeste
            '#FFFFFF'  // Blanco
        ];
        
        // Ajustar tama√±o del canvas
        function ajustarCanvas() {
            conexionesCanvas.width = diagrama.clientWidth;
            conexionesCanvas.height = diagrama.clientHeight;
            dibujarConexiones();
        }
        
        // Funci√≥n para oscurecer un color
        function oscurecerColor(colorHex, porcentaje) {
            let r = parseInt(colorHex.slice(1, 3), 16);
            let g = parseInt(colorHex.slice(3, 5), 16);
            let b = parseInt(colorHex.slice(5, 7), 16);
            
            r = Math.floor(r * (100 - porcentaje) / 100);
            g = Math.floor(g * (100 - porcentaje) / 100);
            b = Math.floor(b * (100 - porcentaje) / 100);
            
            r = Math.max(0, Math.min(255, r));
            g = Math.max(0, Math.min(255, g));
            b = Math.max(0, Math.min(255, b));
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        // Dibujar todas las conexiones
        function dibujarConexiones() {
            ctx.clearRect(0, 0, conexionesCanvas.width, conexionesCanvas.height);
            
            conexiones.forEach(conexion => {
                const desdeElemento = document.querySelector(`[data-id="${conexion.desde}"]`);
                const hastaElemento = document.querySelector(`[data-id="${conexion.hasta}"]`);
                
                if (desdeElemento && hastaElemento) {
                    const diagramaRect = diagrama.getBoundingClientRect();
                    const desdeRect = desdeElemento.getBoundingClientRect();
                    const hastaRect = hastaElemento.getBoundingClientRect();
                    
                    const centroDesdeX = desdeRect.left - diagramaRect.left + desdeElemento.offsetWidth / 2;
                    const centroDesdeY = desdeRect.top - diagramaRect.top + desdeElemento.offsetHeight / 2;
                    const centroHastaX = hastaRect.left - diagramaRect.left + hastaElemento.offsetWidth / 2;
                    const centroHastaY = hastaRect.top - diagramaRect.top + hastaElemento.offsetHeight / 2;
                    
                    // Dibujar l√≠nea
                    ctx.beginPath();
                    ctx.moveTo(centroDesdeX, centroDesdeY);
                    ctx.lineTo(centroHastaX, centroHastaY);
                    ctx.strokeStyle = colorConexion;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // Dibujar punto en el centro de cada extremo
                    const colorPuntos = oscurecerColor(colorConexion, 30);
                    
                    ctx.beginPath();
                    ctx.arc(centroDesdeX, centroDesdeY, 4, 0, Math.PI * 2);
                    ctx.fillStyle = colorPuntos;
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.arc(centroHastaX, centroHastaY, 4, 0, Math.PI * 2);
                    ctx.fillStyle = colorPuntos;
                    ctx.fill();
                    
                    // Dibujar flecha
                    dibujarFlecha(ctx, centroDesdeX, centroDesdeY, centroHastaX, centroHastaY);
                }
            });
        }
        
        // Funci√≥n para dibujar flecha
        function dibujarFlecha(ctx, fromX, fromY, toX, toY) {
            const headlen = 15;
            const angle = Math.atan2(toY - fromY, toX - fromX);
            
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(
                toX - headlen * Math.cos(angle - Math.PI / 6),
                toY - headlen * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(toX, toY);
            ctx.lineTo(
                toX - headlen * Math.cos(angle + Math.PI / 6),
                toY - headlen * Math.sin(angle + Math.PI / 6)
            );
            ctx.strokeStyle = colorConexion;
            ctx.lineWidth = 3;
            ctx.stroke();
        }
        
        // Funci√≥n para calcular contraste de color
        function obtenerColorTexto(colorFondo) {
            let r, g, b;
            
            if (colorFondo.startsWith('#')) {
                r = parseInt(colorFondo.substr(1, 2), 16);
                g = parseInt(colorFondo.substr(3, 2), 16);
                b = parseInt(colorFondo.substr(5, 2), 16);
            } else if (colorFondo.startsWith('rgb')) {
                const match = colorFondo.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (match) {
                    r = parseInt(match[1]);
                    g = parseInt(match[2]);
                    b = parseInt(match[3]);
                }
            }
            
            const luminosidad = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            return luminosidad > 0.5 ? '#000000' : '#ffffff';
        }

        // A√±adir conexi√≥n
        function agregarConexion(desdeId, hastaId) {
            const existe = conexiones.some(conexion => 
                (conexion.desde === desdeId && conexion.hasta === hastaId) ||
                (conexion.desde === hastaId && conexion.hasta === desdeId)
            );
            
            if (existe) {
                conexiones = conexiones.filter(conexion => 
                    !((conexion.desde === desdeId && conexion.hasta === hastaId) ||
                      (conexion.desde === hastaId && conexion.hasta === desdeId))
                );
                guardarLocal();
                dibujarConexiones();
                return false;
            } else {
                conexiones.push({
                    id: `conexion_${Date.now()}`,
                    desde: desdeId,
                    hasta: hastaId
                });
                guardarLocal();
                dibujarConexiones();
                return true;
            }
        }
        
        // Eliminar conexiones relacionadas con un elemento
        function eliminarConexionesElemento(elementoId) {
            const antes = conexiones.length;
            conexiones = conexiones.filter(conexion => 
                conexion.desde !== elementoId && conexion.hasta !== elementoId
            );
            
            if (conexiones.length < antes) {
                guardarLocal();
                dibujarConexiones();
            }
        }
        
        // Manejar clic en modo conexi√≥n
        function manejarClicModoConexion(elemento) {
            if (!modoConexion) return;
            
            elemento.classList.add('seleccionada-conexion');
            
            if (!primeraSeleccionConexion) {
                primeraSeleccionConexion = elemento;
                modoConexionInfo.textContent = 'üîó Seleccionado primer objeto - Selecciona el segundo';
            } else if (primeraSeleccionConexion !== elemento) {
                segundaSeleccionConexion = elemento;
                
                const seA√±adio = agregarConexion(
                    primeraSeleccionConexion.dataset.id,
                    segundaSeleccionConexion.dataset.id
                );
                
                const mensaje = seA√±adio ? '‚úÖ Objetos conectados' : '‚ùå Conexi√≥n eliminada';
                modoConexionInfo.textContent = mensaje;
                
                setTimeout(() => {
                    modoConexionInfo.textContent = 'üîó Modo Conexi√≥n Activo - Selecciona dos objetos para conectarlos';
                }, 2000);
                
                primeraSeleccionConexion.classList.remove('seleccionada-conexion');
                segundaSeleccionConexion.classList.remove('seleccionada-conexion');
                primeraSeleccionConexion = null;
                segundaSeleccionConexion = null;
            }
        }

        // Cargar color de fondo
        const colorFondoGuardado = localStorage.getItem('colorFondoDiagrama') || '#2d2d2d';
        diagrama.style.backgroundColor = colorFondoGuardado;
        selectorColorFondo.value = colorFondoGuardado;
        
        // Ajustar canvas inicialmente y en redimensionamiento
        window.addEventListener('load', ajustarCanvas);
        window.addEventListener('resize', ajustarCanvas);

        // Mostrar/ocultar selector de color de fondo
        btnColorFondo.addEventListener('click', () => {
            selectorColorFondo.style.display = selectorColorFondo.style.display === 'block' ? 'none' : 'block';
        });

        // Cambiar color de fondo
        selectorColorFondo.addEventListener('input', (e) => {
            diagrama.style.backgroundColor = e.target.value;
            localStorage.setItem('colorFondoDiagrama', e.target.value);
        });

        // Cerrar selector de color al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!btnColorFondo.contains(e.target) && !selectorColorFondo.contains(e.target)) {
                selectorColorFondo.style.display = 'none';
            }
        });

        // Funci√≥n para obtener posici√≥n centrada en pantalla
        function obtenerPosicionCentrada(ancho, alto) {
            const diagramaRect = diagrama.getBoundingClientRect();
            const x = (diagramaRect.width - ancho) / 2;
            const y = (diagramaRect.height - alto) / 2;
            return { x, y };
        }

        // Obtener datos del diagrama actual para guardar
        function obtenerDatosDiagrama() {
            const elementos = [];
            const elementosDOM = document.querySelectorAll('.nota, .tachuela');
            
            elementosDOM.forEach(el => {
                const elData = {
                    id: el.dataset.id,
                    tipo: el.classList.contains('imagen') ? 'imagen' : el.classList.contains('tachuela') ? 'tachuela' : 'texto',
                    x: parseInt(el.style.left) || 0,
                    y: parseInt(el.style.top) || 0,
                    width: parseInt(el.style.width) || (el.classList.contains('tachuela') ? 30 : 200),
                    height: parseInt(el.style.height) || (el.classList.contains('tachuela') ? 30 : 100),
                    color: el.style.backgroundColor,
                    bloqueada: el.dataset.bloqueada === 'true'
                };
                
                if (elData.tipo === 'texto') {
                    const contenido = el.querySelector('.contenido-nota');
                    elData.texto = contenido.innerText;
                } else if (elData.tipo === 'imagen') {
                    const img = el.querySelector('img');
                    elData.imagenBase64 = img.src;
                    elData.alt = img.alt || 'Imagen';
                    elData.lockAspect = el.classList.contains('lock-aspect');
                } else if (elData.tipo === 'tachuela') {
                    elData.colorTachuela = el.style.backgroundColor;
                }
                
                elementos.push(elData);
            });
            
            return {
                elementos: elementos,
                fondo: diagrama.style.backgroundColor,
                fecha: new Date().toISOString(),
                notaIdCounter: notaIdCounter,
                conexiones: conexiones,
                colorConexion: colorConexion
            };
        }

        // Guardar en localStorage
        function guardarLocal() {
            const datos = obtenerDatosDiagrama();
            localStorage.setItem('elementos', JSON.stringify(datos.elementos));
            localStorage.setItem('notaIdCounter', notaIdCounter.toString());
            localStorage.setItem('conexiones', JSON.stringify(conexiones));
            localStorage.setItem('colorConexion', colorConexion);
        }

        // Cargar desde localStorage
        function cargarLocal() {
            const elementosGuardados = localStorage.getItem('elementos');
            const conexionesGuardadas = localStorage.getItem('conexiones');
            const colorConexionGuardado = localStorage.getItem('colorConexion');
            
            if (elementosGuardados) {
                diagrama.innerHTML = '<canvas id="conexiones-canvas"></canvas>';
                conexionesCanvas = document.getElementById('conexiones-canvas');
                ctx = conexionesCanvas.getContext('2d');
                const elementos = JSON.parse(elementosGuardados);
                
                elementos.forEach(elData => {
                    if (elData.tipo === 'texto') {
                        crearNotaDesdeDatos(elData);
                    } else if (elData.tipo === 'imagen') {
                        crearImagenDesdeDatos(elData);
                    } else if (elData.tipo === 'tachuela') {
                        crearTachuelaDesdeDatos(elData);
                    }
                    setTimeout(() => {
                        const elElement = document.querySelector(`[data-id="${elData.id}"]`);
                        if (elElement && elData.tipo === 'texto') {
                            const contenido = elElement.querySelector('.contenido-nota');
                            if (contenido) {
                                elElement.style.height = 'auto';
                                const alturaNecesaria = contenido.scrollHeight + 30;
                                elElement.style.height = Math.max(100, alturaNecesaria) + 'px';
                            }
                        }
                    }, 100);
                });
                
                const maxId = Math.max(...elementos.map(e => parseInt(e.id)), 0);
                notaIdCounter = maxId + 1;
            }
            
            if (conexionesGuardadas) {
                conexiones = JSON.parse(conexionesGuardadas);
            }
            
            if (colorConexionGuardado) {
                colorConexion = colorConexionGuardado;
                setTimeout(() => {
                    const btnActivo = document.querySelector(`.color-conexion-btn[data-color="${colorConexion}"]`);
                    if (btnActivo) {
                        document.querySelectorAll('.color-conexion-btn').forEach(btn => btn.classList.remove('activo'));
                        btnActivo.classList.add('activo');
                    }
                }, 100);
            }
            
            setTimeout(() => {
                ajustarCanvas();
                dibujarConexiones();
            }, 100);
        }

        // Crear una nota de texto desde datos guardados
        function crearNotaDesdeDatos(notaData) {
            const nota = document.createElement('div');
            nota.className = 'nota';
            nota.dataset.id = notaData.id;
            nota.style.left = notaData.x + 'px';
            nota.style.top = notaData.y + 'px';
            nota.style.width = notaData.width + 'px';
            nota.style.height = 'auto';
            nota.style.minHeight = '100px';
            nota.style.backgroundColor = notaData.color || '#333';
            nota.style.color = obtenerColorTexto(notaData.color || '#333');
            nota.dataset.bloqueada = notaData.bloqueada ? 'true' : 'false';
            
            nota.innerHTML = `
                <div class="contenido-nota">${notaData.texto || ''}</div>
                <button class="boton-menu">‚öôÔ∏è</button>
                <div class="menu-desplegable">
                    <label>Color de nota:</label>
                    <input type="color" class="color-picker" value="${notaData.color || '#333'}">
                    <button class="btn-clonar">Clonar</button>
                    <button class="btn-bloquear">${notaData.bloqueada ? 'Desbloquear' : 'Bloquear'} Posici√≥n</button>
                    <button class="btn-eliminar">Eliminar</button>
                </div>
            `;

            diagrama.appendChild(nota);
            
            if (notaData.bloqueada) {
                nota.classList.add('bloqueada');
            }

            configurarEventosNota(nota);
        }

        // Crear una imagen desde datos guardados
        function crearImagenDesdeDatos(imagenData) {
            const nota = document.createElement('div');
            nota.className = `nota imagen ${imagenData.lockAspect ? 'lock-aspect' : ''}`;
            nota.dataset.id = imagenData.id;
            nota.style.left = imagenData.x + 'px';
            nota.style.top = imagenData.y + 'px';
            nota.style.width = imagenData.width + 'px';
            nota.style.height = imagenData.height + 'px';
            nota.dataset.bloqueada = imagenData.bloqueada ? 'true' : 'false';
            
            nota.innerHTML = `
                <div class="contenido-imagen">
                    <img src="${imagenData.imagenBase64}" alt="${imagenData.alt || 'Imagen'}">
                </div>
                <button class="boton-menu">‚öôÔ∏è</button>
                <div class="menu-desplegable">
                    <button class="btn-lock-aspect">üîí Bloquear Proporciones</button>
                    <button class="btn-eliminar">Eliminar</button>
                </div>
            `;

            diagrama.appendChild(nota);
            
            if (imagenData.bloqueada) {
                nota.classList.add('bloqueada');
            }

            configurarEventosNota(nota);
        }

        // Crear una nueva tachuela EN EL CENTRO
        function crearTachuela(color = '#FFD700') {
            const id = notaIdCounter++;
            const tama√±o = 30;
            
            // Calcular posici√≥n centrada
            const pos = obtenerPosicionCentrada(tama√±o, tama√±o);
            
            const tachuela = document.createElement('div');
            tachuela.className = 'tachuela';
            tachuela.dataset.id = id;
            tachuela.style.left = pos.x + 'px';
            tachuela.style.top = pos.y + 'px';
            tachuela.style.backgroundColor = color;
            tachuela.dataset.bloqueada = 'false';
            
            // MEN√ö SIMPLIFICADO: Solo clonar y eliminar
            tachuela.innerHTML = `
                
                <button class="boton-menu">‚öôÔ∏è</button>
                <div class="menu-desplegable">
                    <button class="btn-clonar">Clonar</button>
                    <button class="btn-eliminar">Eliminar</button>
                </div>
            `;

            diagrama.appendChild(tachuela);
            configurarEventosTachuela(tachuela);
            guardarLocal();
            
            return tachuela;
        }

        // Crear tachuela desde datos guardados
        function crearTachuelaDesdeDatos(tachuelaData) {
            const tachuela = document.createElement('div');
            tachuela.className = 'tachuela';
            tachuela.dataset.id = tachuelaData.id;
            tachuela.style.left = tachuelaData.x + 'px';
            tachuela.style.top = tachuelaData.y + 'px';
            tachuela.style.width = tachuelaData.width + 'px';
            tachuela.style.height = tachuelaData.height + 'px';
            tachuela.style.backgroundColor = tachuelaData.colorTachuela || '#FFD700';
            tachuela.dataset.bloqueada = tachuelaData.bloqueada ? 'true' : 'false';
            
            // MEN√ö SIMPLIFICADO: Solo clonar y eliminar
            tachuela.innerHTML = `
                
                <button class="boton-menu">‚öôÔ∏è</button>
                <div class="menu-desplegable">
                    <button class="btn-clonar">Clonar</button>
                    <button class="btn-eliminar">Eliminar</button>
                </div>
            `;

            diagrama.appendChild(tachuela);
            
            if (tachuelaData.bloqueada) {
                tachuela.classList.add('bloqueada');
            }

            configurarEventosTachuela(tachuela);
        }

        // Configurar eventos para tachuela - SIMPLIFICADO
        function configurarEventosTachuela(elemento) {
            const botonMenu = elemento.querySelector('.boton-menu');
            const menu = elemento.querySelector('.menu-desplegable');
// Cerrar men√∫ al hacer clic fuera
document.addEventListener('click', (e) => {
    if (!elemento.contains(e.target)) {
        menu.style.display = 'none';
    }
});
            const btnEliminar = elemento.querySelector('.btn-eliminar');
            const btnClonar = elemento.querySelector('.btn-clonar');
            
            // Clonar tachuela
            btnClonar.addEventListener('click', () => {
                const rect = elemento.getBoundingClientRect();
                const nuevaTachuela = crearTachuela(elemento.style.backgroundColor);
                nuevaTachuela.style.left = (rect.left + 20) + 'px';
                nuevaTachuela.style.top = (rect.top + 20) + 'px';
                menu.style.display = 'none';
            });
            
            // Eliminar tachuela
            btnEliminar.addEventListener('click', () => {
                elementoAEliminar = elemento;
                modalEliminar.style.display = 'flex';
                menu.style.display = 'none';
            });
            
            // Men√∫ toggle
            botonMenu.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
            
            // Cerrar men√∫ al clic fuera
            document.addEventListener('click', (e) => {
                if (!elemento.contains(e.target)) {
                    menu.style.display = 'none';
                }
            });
            
            // Modo conexi√≥n
            elemento.addEventListener('click', (e) => {
                if (modoConexion && !e.target.classList.contains('boton-menu')) {
                    e.stopPropagation();
                    manejarClicModoConexion(elemento);
                }
            });
            
            // Arrastrable
            hacerArrastrable(elemento);
        }

        // Configurar eventos de una nota/imagen
        function configurarEventosNota(elemento) {
            const botonMenu = elemento.querySelector('.boton-menu');
            const menu = elemento.querySelector('.menu-desplegable');
            const btnEliminar = elemento.querySelector('.btn-eliminar');
            
            if (elemento.classList.contains('imagen')) {
                const img = elemento.querySelector('img');
                img.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                    return false;
                });
            }
            
            if (elemento.classList.contains('nota') && !elemento.classList.contains('imagen')) {
                const colorPicker = elemento.querySelector('.color-picker');
                const btnClonar = elemento.querySelector('.btn-clonar');
                const btnBloquear = elemento.querySelector('.btn-bloquear');
                const contenido = elemento.querySelector('.contenido-nota');
                
                if (!isMobile) {
                    contenido.addEventListener('click', (e) => {
                        if (e.detail === 2) {
                            e.stopPropagation();
                            notaActual = elemento;
                            textoModal.value = contenido.innerText;
                            modalTexto.style.display = 'flex';
                            textoModal.focus();
                        }
                    });
                } else {
                    contenido.addEventListener('click', (e) => {
                        e.stopPropagation();
                        notaActual = elemento;
                        textoModal.value = contenido.innerText;
                        modalTexto.style.display = 'flex';
                        textoModal.focus();
                    });
                }
                
                colorPicker.addEventListener('change', (e) => {
                    elemento.style.backgroundColor = e.target.value;
                    elemento.style.color = obtenerColorTexto(e.target.value);
                    menu.style.display = 'none';
                    guardarLocal();
                });
                
                btnClonar.addEventListener('click', () => {
                    const rect = elemento.getBoundingClientRect();
                    const nuevaNota = crearNota(
                        rect.left + 20, 
                        rect.top + 20
                    );
                    
                    const nuevoContenido = nuevaNota.querySelector('.contenido-nota');
                    nuevoContenido.innerText = contenido.innerText;
                    nuevaNota.style.backgroundColor = elemento.style.backgroundColor;
                    nuevaNota.style.color = obtenerColorTexto(elemento.style.backgroundColor);
                    
                    menu.style.display = 'none';
                    guardarLocal();
                });
                
                btnBloquear.addEventListener('click', () => {
                    const bloqueada = elemento.dataset.bloqueada === 'true';
                    elemento.dataset.bloqueada = (!bloqueada).toString();
                    elemento.classList.toggle('bloqueada', !bloqueada);
                    btnBloquear.textContent = bloqueada ? 'Bloquear Posici√≥n' : 'Desbloquear Posici√≥n';
                    menu.style.display = 'none';
                    guardarLocal();
                });
            } else if (elemento.classList.contains('imagen')) {
                const btnLockAspect = elemento.querySelector('.btn-lock-aspect');
const btnReinsertar = document.createElement('button');
btnReinsertar.className = 'btn-reinsertar';
btnReinsertar.textContent = 'üìé Reinsertar Imagen';
btnReinsertar.style.cssText = 'display: block; width: 100%; margin: 6px 0; padding: 8px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; background: #9C27B0; color: white;';

btnLockAspect.addEventListener('click', () => {
    elemento.classList.toggle('lock-aspect');
    const locked = elemento.classList.contains('lock-aspect');
    btnLockAspect.textContent = locked ? 'üîì Desbloquear Proporciones' : 'üîí Bloquear Proporciones';
    btnLockAspect.style.background = locked ? '#FF9800' : '#2196F3';
    guardarLocal();
});

btnReinsertar.addEventListener('click', () => {
    const img = elemento.querySelector('img');
    const imgSrc = img.src;
    
    // Crear nueva imagen con la misma fuente
    crearImagen(imgSrc);
    
    // Cerrar men√∫
    menu.style.display = 'none';
});

if (elemento.classList.contains('lock-aspect')) {
    btnLockAspect.textContent = 'üîì Desbloquear Proporciones';
    btnLockAspect.style.background = '#FF9800';
}

// Insertar el bot√≥n en el men√∫ despu√©s de btnLockAspect
menu.insertBefore(btnReinsertar, btnLockAspect.nextSibling);
            }
            
            botonMenu.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
            
            btnEliminar.addEventListener('click', () => {
                elementoAEliminar = elemento;
                modalEliminar.style.display = 'flex';
                menu.style.display = 'none';
            });
            
            document.addEventListener('click', (e) => {
                if (!elemento.contains(e.target)) {
                    menu.style.display = 'none';
                }
            });
            
            elemento.addEventListener('click', (e) => {
                if (modoConexion && !e.target.classList.contains('boton-menu')) {
                    e.stopPropagation();
                    manejarClicModoConexion(elemento);
                }
            });
            
            hacerArrastrable(elemento);
        }

        // Crear una nueva nota de texto EN EL CENTRO
        function crearNota() {
            const id = notaIdCounter++;
            const ancho = 200;
            const alto = 150;
            
            // Calcular posici√≥n centrada
            const pos = obtenerPosicionCentrada(ancho, alto);
            
            const nota = document.createElement('div');
            nota.className = 'nota';
            nota.dataset.id = id;
            nota.style.left = pos.x + 'px';
            nota.style.top = pos.y + 'px';
            nota.style.backgroundColor = '#333';
            nota.style.color = obtenerColorTexto('#333');
            nota.style.height = 'auto';
            nota.style.minHeight = '100px';
            nota.dataset.bloqueada = 'false';
            
            nota.innerHTML = `
                <div class="contenido-nota"></div>
                <button class="boton-menu">‚öôÔ∏è</button>
                <div class="menu-desplegable">
                    <label>Color de nota:</label>
                    <input type="color" class="color-picker" value="#333333">
                    <button class="btn-clonar">Clonar</button>
                    <button class="btn-bloquear">Bloquear Posici√≥n</button>
                    <button class="btn-eliminar">Eliminar</button>
                </div>
            `;

            diagrama.appendChild(nota);
            configurarEventosNota(nota);
            
            // Abrir modal para editar
            setTimeout(() => {
                notaActual = nota;
                textoModal.value = '';
                modalTexto.style.display = 'flex';
                textoModal.focus();
            }, 100);
            
            guardarLocal();
            
            return nota;
        }

        function crearImagen(base64) {
    const id = notaIdCounter++;
    
    // Posici√≥n fija inicial
    let x = 50;
    let y = 50;
    
    const imgTemp = new Image();
    imgTemp.onload = function() {
        const ratio = imgTemp.width / imgTemp.height;
        let ancho, alto;
        
        // Tama√±o m√°ximo ajustado
        const maxSize = 250;
        if (ratio > 1) {
            ancho = Math.min(maxSize, maxSize * ratio);
            alto = maxSize;
        } else {
            ancho = maxSize;
            alto = Math.min(maxSize, maxSize / ratio);
        }
        
        // Asegurar tama√±o m√≠nimo
        ancho = Math.max(150, ancho);
        alto = Math.max(150, alto);
        
        // Crear la nota de imagen
        const nota = document.createElement('div');
        nota.className = 'nota imagen lock-aspect';
        nota.dataset.id = id;
        nota.style.left = x + 'px';
        nota.style.top = y + 'px';
        nota.style.width = ancho + 'px';
        nota.style.height = alto + 'px';
        nota.dataset.bloqueada = 'false';
        
        nota.innerHTML = `
            <div class="contenido-imagen">
                <img src="${base64}" alt="Imagen insertada" style="width:100%; height:100%; object-fit:contain;">
            </div>
            <button class="boton-menu">‚öôÔ∏è</button>
            <div class="menu-desplegable">
                <button class="btn-lock-aspect">üîì Desbloquear Proporciones</button>
                <button class="btn-eliminar">Eliminar</button>
            </div>
        `;

        diagrama.appendChild(nota);
        configurarEventosNota(nota);
        guardarLocal();
        dibujarConexiones();
    };
    imgTemp.src = base64;
}

        // Funci√≥n para hacer arrastrable
        function hacerArrastrable(elemento) {
            let estaArrastrando = false;
            
            elemento.addEventListener('mousedown', iniciarArrastre);
            elemento.addEventListener('touchstart', iniciarArrastreTouch, { passive: false });

            function iniciarArrastre(e) {
                if (elemento.dataset.bloqueada === 'true' || 
                    e.target.classList.contains('boton-menu') || 
                    e.target.closest('.menu-desplegable') ||
                    modoConexion) {
                    return;
                }
                
                estaArrastrando = true;
                notaArrastrandose = elemento;
                const rect = elemento.getBoundingClientRect();
                offset.x = e.clientX - rect.left;
                offset.y = e.clientY - rect.top;
                
                document.addEventListener('mousemove', arrastrar);
                document.addEventListener('mouseup', detenerArrastre);
            }

            function iniciarArrastreTouch(e) {
                if (elemento.dataset.bloqueada === 'true' || 
                    e.target.classList.contains('boton-menu') || 
                    e.target.closest('.menu-desplegable') ||
                    modoConexion) {
                    return;
                }
                
                e.preventDefault();
                estaArrastrando = true;
                const touch = e.touches[0];
                notaArrastrandose = elemento;
                const rect = elemento.getBoundingClientRect();
                offset.x = touch.clientX - rect.left;
                offset.y = touch.clientY - rect.top;
                
                document.addEventListener('touchmove', arrastrarTouch, { passive: false });
                document.addEventListener('touchend', detenerArrastreTouch);
            }

            function arrastrar(e) {
    if (!estaArrastrando || !notaArrastrandose) return;
    
    const diagramaRect = diagrama.getBoundingClientRect();
    const nuevaX = e.clientX - diagramaRect.left - offset.x;
    const nuevaY = e.clientY - diagramaRect.top - offset.y;
    
    // USAR OFFSETWIDTH/OFFSETHEIGHT QUE SON LAS DIMENSIONES REALES
    const elementoWidth = notaArrastrandose.offsetWidth;
    const elementoHeight = notaArrastrandose.offsetHeight;
    
    // Calcular l√≠mites asegurando que el elemento quede dentro
    const limiteX = Math.max(0, Math.min(nuevaX, diagrama.clientWidth - elementoWidth));
    const limiteY = Math.max(0, Math.min(nuevaY, diagrama.clientHeight - elementoHeight));
    
    notaArrastrandose.style.left = limiteX + 'px';
    notaArrastrandose.style.top = limiteY + 'px';
    
    dibujarConexiones();
}

function arrastrarTouch(e) {
    if (!estaArrastrando || !notaArrastrandose) return;
    
    e.preventDefault();
    const touch = e.touches[0];
    const diagramaRect = diagrama.getBoundingClientRect();
    const nuevaX = touch.clientX - diagramaRect.left - offset.x;
    const nuevaY = touch.clientY - diagramaRect.top - offset.y;
    
    // USAR OFFSETWIDTH/OFFSETHEIGHT
    const elementoWidth = notaArrastrandose.offsetWidth;
    const elementoHeight = notaArrastrandose.offsetHeight;
    
    const limiteX = Math.max(0, Math.min(nuevaX, diagrama.clientWidth - elementoWidth));
    const limiteY = Math.max(0, Math.min(nuevaY, diagrama.clientHeight - elementoHeight));
    
    notaArrastrandose.style.left = limiteX + 'px';
    notaArrastrandose.style.top = limiteY + 'px';
    
    dibujarConexiones();
}

            function detenerArrastre() {
                if (estaArrastrando && notaArrastrandose) {
                    guardarLocal();
                }
                estaArrastrando = false;
                notaArrastrandose = null;
                document.removeEventListener('mousemove', arrastrar);
                document.removeEventListener('mouseup', detenerArrastre);
                
                dibujarConexiones();
            }

            function detenerArrastreTouch() {
                if (estaArrastrando && notaArrastrandose) {
                    guardarLocal();
                }
                estaArrastrando = false;
                notaArrastrandose = null;
                document.removeEventListener('touchmove', arrastrarTouch);
                document.removeEventListener('touchend', detenerArrastreTouch);
                
                dibujarConexiones();
            }
        }

        // FUNCIONES DE FIREBASE
        function mostrarMensajeFirebase(texto, tipo = 'exito') {
            mensajeFirebase.textContent = texto;
            mensajeFirebase.className = `mensaje-estado mensaje-${tipo}`;
            mensajeFirebase.style.display = 'block';
            
            setTimeout(() => {
                mensajeFirebase.style.display = 'none';
            }, 3000);
        }

        function cargarSlotsFirebase() {
            loadingSlots.style.display = 'block';
            carouselSlots.style.display = 'none';
            sinSlots.style.display = 'none';
            carouselSlots.innerHTML = '';
            
            slotsRef.once('value')
                .then((snapshot) => {
                    loadingSlots.style.display = 'none';
                    const datos = snapshot.val();
                    
                    if (!datos) {
                        sinSlots.style.display = 'block';
                        return;
                    }
                    
                    const slotsArray = Object.entries(datos).map(([key, value]) => ({
                        id: key,
                        ...value
                    })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    if (slotsArray.length === 0) {
                        sinSlots.style.display = 'block';
                        return;
                    }
                    
                    slotsArray.forEach(slot => {
                        const slotElement = document.createElement('div');
                        slotElement.className = 'slot-item';
                        slotElement.dataset.slotId = slot.id;
                        
                        const fecha = new Date(slot.fecha);
                        const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        slotElement.innerHTML = `
                            <div class="slot-header">
                                <div class="slot-titulo">${slot.titulo || 'Sin t√≠tulo'}</div>
                                <div class="slot-fecha">${fechaFormateada}</div>
                            </div>
                            <div class="slot-actions">
                                <button class="slot-btn btn-sobrescribir" data-action="sobrescribir">Sobreescribir</button>
                                <button class="slot-btn btn-cargar" data-action="cargar">Cargar</button>
                                <button class="slot-btn btn-borrar" data-action="borrar">Borrar</button>
                            </div>
                        `;
                        
                        carouselSlots.appendChild(slotElement);
                    });
                    
                    carouselSlots.style.display = 'block';
                })
                .catch((error) => {
                    loadingSlots.style.display = 'none';
                    mostrarMensajeFirebase('Error al cargar slots: ' + error.message, 'error');
                });
        }

        function guardarSlotFirebase(titulo) {
            if (!titulo.trim()) {
                mostrarMensajeFirebase('Por favor, ingresa un t√≠tulo para el slot', 'error');
                return;
            }
            
            const datos = obtenerDatosDiagrama();
            datos.titulo = titulo.trim();
            
            const nuevoSlotRef = slotsRef.push();
            nuevoSlotRef.set(datos)
                .then(() => {
                    mostrarMensajeFirebase('Slot guardado exitosamente en Firebase!', 'exito');
                    modalNuevoSlot.style.display = 'none';
                    tituloSlotInput.value = '';
                    cargarSlotsFirebase();
                })
                .catch((error) => {
                    mostrarMensajeFirebase('Error al guardar: ' + error.message, 'error');
                });
        }

        function sobrescribirSlotFirebase(slotId) {
            const datos = obtenerDatosDiagrama();
            
            slotsRef.child(slotId).update({
                elementos: datos.elementos,
                fondo: datos.fondo,
                fecha: new Date().toISOString(),
                notaIdCounter: datos.notaIdCounter,
                conexiones: datos.conexiones,
                colorConexion: datos.colorConexion
            })
            .then(() => {
                mostrarMensajeFirebase('Slot actualizado exitosamente!', 'exito');
                cargarSlotsFirebase();
            })
            .catch((error) => {
                mostrarMensajeFirebase('Error al actualizar: ' + error.message, 'error');
            });
        }

        function cargarSlotFirebase(slotId) {
            loadingSlots.style.display = 'block';
            
            slotsRef.child(slotId).once('value')
                .then((snapshot) => {
                    loadingSlots.style.display = 'none';
                    const datos = snapshot.val();
                    
                    if (!datos) {
                        mostrarMensajeFirebase('Slot no encontrado', 'error');
                        return;
                    }
                    
                    try {
                        diagrama.innerHTML = '<canvas id="conexiones-canvas"></canvas>';
                        conexionesCanvas = document.getElementById('conexiones-canvas');
                        ctx = conexionesCanvas.getContext('2d');
                        
                        diagrama.style.backgroundColor = datos.fondo || '#2d2d2d';
                        selectorColorFondo.value = datos.fondo || '#2d2d2d';
                        localStorage.setItem('colorFondoDiagrama', datos.fondo || '#2d2d2d');
                        
                        if (datos.elementos && Array.isArray(datos.elementos)) {
                            datos.elementos.forEach(elData => {
                                if (elData.tipo === 'texto') {
                                    crearNotaDesdeDatos(elData);
                                } else if (elData.tipo === 'imagen') {
                                    crearImagenDesdeDatos(elData);
                                } else if (elData.tipo === 'tachuela') {
                                    crearTachuelaDesdeDatos(elData);
                                }
                            });
                        }
                        
                        notaIdCounter = datos.notaIdCounter || 1;
                        
                        if (datos.conexiones) {
                            conexiones = datos.conexiones;
                            localStorage.setItem('conexiones', JSON.stringify(conexiones));
                        }
                        
                        if (datos.colorConexion) {
                            colorConexion = datos.colorConexion;
                            localStorage.setItem('colorConexion', colorConexion);
                            const btnActivo = document.querySelector(`.color-conexion-btn[data-color="${colorConexion}"]`);
                            if (btnActivo) {
                                document.querySelectorAll('.color-conexion-btn').forEach(btn => btn.classList.remove('activo'));
                                btnActivo.classList.add('activo');
                            }
                        }
                        
                        setTimeout(() => {
                            ajustarCanvas();
                            dibujarConexiones();
                        }, 100);
                        
                        modalFirebase.style.display = 'none';
                        mostrarMensajeFirebase('Diagrama cargado exitosamente!', 'exito');
                    } catch (error) {
                        console.error('Error cargando slot:', error);
                        mostrarMensajeFirebase('Error al cargar diagrama', 'error');
                    }
                })
                .catch((error) => {
                    loadingSlots.style.display = 'none';
                    mostrarMensajeFirebase('Error al cargar: ' + error.message, 'error');
                });
        }

        function eliminarSlotFirebase(slotId) {
            slotsRef.child(slotId).remove()
                .then(() => {
                    mostrarMensajeFirebase('Slot eliminado exitosamente!', 'exito');
                    cargarSlotsFirebase();
                })
                .catch((error) => {
                    mostrarMensajeFirebase('Error al eliminar: ' + error.message, 'error');
                });
        }

        // NUEVO: Funci√≥n para mostrar/ocultar UI
        function toggleUI() {
            uiVisible = !uiVisible;
            
            if (uiVisible) {
                btnToggleUI.textContent = 'üëÅÔ∏è';
                btnToggleUI.classList.remove('oculta');
                controlPanel.classList.remove('oculta');
                controlConexion.classList.remove('oculta');
            } else {
                btnToggleUI.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                btnToggleUI.classList.add('oculta');
                controlPanel.classList.add('oculta');
                controlConexion.classList.add('oculta');
                selectorColorFondo.style.display = 'none';
            }
            
            localStorage.setItem('uiVisible', uiVisible);
        }

        // Event listeners para cambiar color de conexi√≥n
        document.querySelectorAll('.color-conexion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                colorConexion = btn.dataset.color;
                localStorage.setItem('colorConexion', colorConexion);
                
                document.querySelectorAll('.color-conexion-btn').forEach(b => {
                    b.classList.remove('activo');
                });
                
                btn.classList.add('activo');
                dibujarConexiones();
                
                modoConexionInfo.textContent = `‚úÖ Color de conexi√≥n cambiado a ${btn.title}`;
                modoConexionInfo.style.display = 'block';
                modoConexionInfo.style.background = colorConexion;
                
                setTimeout(() => {
                    if (!modoConexion) {
                        modoConexionInfo.style.display = 'none';
                    }
                }, 2000);
            });
        });

        // Event listeners para botones
        btnToggleUI.addEventListener('click', toggleUI);
        
        btnAnadir.addEventListener('click', () => {
            crearNota();
        });

        // Bot√≥n A√±adir Tachuela simplificado - crea directamente con color aleatorio
        btnAnadirTachuela.addEventListener('click', () => {
            const colorAleatorio = coloresTachuela[Math.floor(Math.random() * coloresTachuela.length)];
            crearTachuela(colorAleatorio);
        });

        btnConectar.addEventListener('click', () => {
            modoConexion = !modoConexion;
            
            if (modoConexion) {
                btnConectar.classList.add('activo');
                modoConexionInfo.style.display = 'block';
                modoConexionInfo.textContent = 'üîó Modo Conexi√≥n Activo - Selecciona dos objetos para conectarlos';
                modoConexionInfo.style.background = colorConexion;
                primeraSeleccionConexion = null;
                segundaSeleccionConexion = null;
                
                document.querySelectorAll('.seleccionada-conexion').forEach(el => {
                    el.classList.remove('seleccionada-conexion');
                });
            } else {
                btnConectar.classList.remove('activo');
                modoConexionInfo.style.display = 'none';
                primeraSeleccionConexion = null;
                segundaSeleccionConexion = null;
                
                document.querySelectorAll('.seleccionada-conexion').forEach(el => {
                    el.classList.remove('seleccionada-conexion');
                });
            }
        });

        btnLimpiar.addEventListener('click', () => {
            modalLimpiar.style.display = 'flex';
        });

        confirmarLimpiarBtn.addEventListener('click', () => {
            diagrama.innerHTML = '<canvas id="conexiones-canvas"></canvas>';
            conexionesCanvas = document.getElementById('conexiones-canvas');
            ctx = conexionesCanvas.getContext('2d');
            
            conexiones = [];
            notaIdCounter = 1;
            ajustarCanvas();
            guardarLocal();
            modalLimpiar.style.display = 'none';
            alert('Pizarra limpiada exitosamente');
        });

        cancelarLimpiarBtn.addEventListener('click', () => {
            modalLimpiar.style.display = 'none';
        });

        btnFirebase.addEventListener('click', () => {
            cargarSlotsFirebase();
            modalFirebase.style.display = 'flex';
        });

        btnNuevoSlot.addEventListener('click', () => {
            modalFirebase.style.display = 'none';
            modalNuevoSlot.style.display = 'flex';
            tituloSlotInput.focus();
        });

        guardarNuevoSlotBtn.addEventListener('click', () => {
            guardarSlotFirebase(tituloSlotInput.value);
        });

        cancelarNuevoSlotBtn.addEventListener('click', () => {
            modalNuevoSlot.style.display = 'none';
            tituloSlotInput.value = '';
            modalFirebase.style.display = 'flex';
        });

        carouselSlots.addEventListener('click', (e) => {
            const slotItem = e.target.closest('.slot-item');
            if (!slotItem) return;
            
            const slotId = slotItem.dataset.slotId;
            const action = e.target.dataset.action;
            
            if (!action) return;
            
            switch(action) {
                case 'sobrescribir':
                    if (confirm('¬øEst√°s seguro de que quieres sobrescribir este slot con el diagrama actual?')) {
                        sobrescribirSlotFirebase(slotId);
                    }
                    break;
                    
                case 'cargar':
                    if (confirm('¬øCargar este slot? Se perder√°n los cambios no guardados del diagrama actual.')) {
                        cargarSlotFirebase(slotId);
                    }
                    break;
                    
                case 'borrar':
                    if (confirm('¬øEst√°s seguro de que quieres eliminar este slot permanentemente?')) {
                        eliminarSlotFirebase(slotId);
                    }
                    break;
            }
        });

        // Modal de imagen
        inputImagen.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecciona un archivo de imagen v√°lido.');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                warningSize.style.display = 'block';
            } else {
                warningSize.style.display = 'none';
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                imagenOriginal = event.target.result;
                actualizarVistaPrevia();
            };
            reader.readAsDataURL(file);
        });

        calidadImagen.addEventListener('input', function() {
            valorCalidad.textContent = this.value;
            if (imagenOriginal) {
                actualizarVistaPrevia();
            }
        });

        tamanioImagen.addEventListener('input', function() {
            valorTamanio.textContent = this.value;
            imagenTamanio = parseInt(this.value);
            if (imagenOriginal) {
                actualizarVistaPrevia();
            }
        });

        lockAspectCheckbox.addEventListener('change', function() {
            lockAspectRatio = this.checked;
            if (imagenOriginal) {
                actualizarVistaPrevia();
            }
        });

        function actualizarVistaPrevia() {
            if (!imagenOriginal) return;
            
            const img = new Image();
            img.onload = function() {
                infoDimensiones.textContent = `Dimensiones: ${img.width} √ó ${img.height}px`;
                
                const canvas = document.createElement('canvas');
                const ctxPreview = canvas.getContext('2d');
                
                const maxSize = 800;
                let width = img.width;
                let height = img.height;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctxPreview.drawImage(img, 0, 0, width, height);
                
                const calidad = parseInt(calidadImagen.value) / 100;
                imagenBase64 = canvas.toDataURL('image/jpeg', calidad);
                
                previewImagen.src = imagenBase64;
                previewImagen.style.display = 'block';
                previewImagen.style.width = `${Math.min(imagenTamanio, 500)}px`;
                previewPlaceholder.style.display = 'none';
                
                const tamanioBase64 = imagenBase64.length;
                const tamanioKB = Math.round((tamanioBase64 * 3) / 4 / 1024);
                infoTamanio.textContent = `Tama√±o aproximado: ${tamanioKB} KB`;
                
                if (tamanioKB > 500) {
                    warningSize.style.display = 'block';
                    warningSize.textContent = `‚ö†Ô∏è La imagen es grande (${tamanioKB} KB). Considera reducir m√°s la calidad.`;
                } else if (tamanioKB > 100) {
                    warningSize.style.display = 'block';
                    warningSize.textContent = `‚ö†Ô∏è Imagen de ${tamanioKB} KB. A√∫n puedes reducir calidad si necesitas.`;
                } else {
                    warningSize.style.display = 'none';
                }
            };
            img.src = imagenOriginal;
        }

        btnAnadirImagen.addEventListener('click', () => {
            inputImagen.value = '';
            previewImagen.style.display = 'none';
            previewPlaceholder.style.display = 'block';
            warningSize.style.display = 'none';
            calidadImagen.value = 80;
            valorCalidad.textContent = '80';
            tamanioImagen.value = 300;
            valorTamanio.textContent = '300';
            lockAspectCheckbox.checked = true;
            imagenTamanio = 300;
            infoTamanio.textContent = 'Tama√±o aproximado: --';
            infoDimensiones.textContent = 'Dimensiones: --';
            imagenOriginal = null;
            imagenBase64 = null;
            
            modalImagen.style.display = 'flex';
        });

        insertarImagenBtn.addEventListener('click', () => {
            if (!imagenBase64) {
                alert('Por favor, selecciona una imagen primero.');
                return;
            }
            
            crearImagen(imagenBase64);
            modalImagen.style.display = 'none';
        });

        // Modal de texto
        guardarTextoBtn.addEventListener('click', () => {
            if (notaActual) {
                const contenido = notaActual.querySelector('.contenido-nota');
                contenido.innerText = textoModal.value;
                notaActual.style.height = 'auto';
                const alturaNecesaria = contenido.scrollHeight + 30;
                notaActual.style.height = Math.max(100, alturaNecesaria) + 'px';
                guardarLocal();
            }
            modalTexto.style.display = 'none';
            notaActual = null;
        });

        cancelarTextoBtn.addEventListener('click', () => {
            modalTexto.style.display = 'none';
            notaActual = null;
        });

        cancelarImagenBtn.addEventListener('click', () => {
            modalImagen.style.display = 'none';
        });

        cancelarEliminarBtn.addEventListener('click', () => {
            modalEliminar.style.display = 'none';
            elementoAEliminar = null;
        });

        confirmarEliminarBtn.addEventListener('click', () => {
            if (elementoAEliminar) {
                eliminarConexionesElemento(elementoAEliminar.dataset.id);
                elementoAEliminar.remove();
                guardarLocal();
                dibujarConexiones();
            }
            modalEliminar.style.display = 'none';
            elementoAEliminar = null;
        });

        // Cerrar modales
        [modalTexto, modalImagen, modalFirebase, modalNuevoSlot, modalEliminar, modalLimpiar].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (modal === modalTexto) notaActual = null;
                    if (modal === modalEliminar) elementoAEliminar = null;
                    if (modal === modalNuevoSlot) {
                        tituloSlotInput.value = '';
                        modalFirebase.style.display = 'flex';
                    }
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (modalTexto.style.display === 'flex') {
                    modalTexto.style.display = 'none';
                    notaActual = null;
                } else if (modalImagen.style.display === 'flex') {
                    modalImagen.style.display = 'none';
                } else if (modalFirebase.style.display === 'flex') {
                    modalFirebase.style.display = 'none';
                } else if (modalNuevoSlot.style.display === 'flex') {
                    modalNuevoSlot.style.display = 'none';
                    tituloSlotInput.value = '';
                    modalFirebase.style.display = 'flex';
                } else if (modalEliminar.style.display === 'flex') {
                    modalEliminar.style.display = 'none';
                    elementoAEliminar = null;
                } else if (modalLimpiar.style.display === 'flex') {
                    modalLimpiar.style.display = 'none';
                } else if (modoConexion) {
                    modoConexion = false;
                    btnConectar.classList.remove('activo');
                    modoConexionInfo.style.display = 'none';
                    primeraSeleccionConexion = null;
                    segundaSeleccionConexion = null;
                    
                    document.querySelectorAll('.seleccionada-conexion').forEach(el => {
                        el.classList.remove('seleccionada-conexion');
                    });
                }
            }
            
            // Atajo de teclado para mostrar/ocultar UI: Ctrl+H
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                toggleUI();
            }
        });

        // Cargar al iniciar
        window.addEventListener('load', () => {
            cargarLocal();
            
            // Configurar UI seg√∫n estado guardado
            if (localStorage.getItem('uiVisible') === 'false') {
                uiVisible = false;
                btnToggleUI.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                btnToggleUI.classList.add('oculta');
                controlPanel.classList.add('oculta');
                controlConexion.classList.add('oculta');
            }
            
            if (!localStorage.getItem('elementos')) {
                // Crear nota de bienvenida EN EL CENTRO
                const id = notaIdCounter++;
                const ancho = 200;
                const alto = 150;
                const pos = obtenerPosicionCentrada(ancho, alto);
                
                const nota = document.createElement('div');
                nota.className = 'nota';
                nota.dataset.id = id;
                nota.style.left = pos.x + 'px';
                nota.style.top = pos.y + 'px';
                nota.style.backgroundColor = '#333';
                nota.style.color = obtenerColorTexto('#333');
                nota.style.height = 'auto';
                nota.style.minHeight = '100px';
                nota.dataset.bloqueada = 'false';
                
                nota.innerHTML = `
                    <div class="contenido-nota">¬°Bienvenido al Creador de Diagramas!\n\nüìù Nuevas notas aparecen en el centro\nüñºÔ∏è Im√°genes tambi√©n en el centro\nüìå Tachuelas simplificadas\nüîó Cambia color de conexiones\nüëÅÔ∏è Oculta/muestra controles\nüî• Guarda en Firebase</div>
                    <button class="boton-menu">‚öôÔ∏è</button>
                    <div class="menu-desplegable">
                        <label>Color de nota:</label>
                        <input type="color" class="color-picker" value="#333333">
                        <button class="btn-clonar">Clonar</button>
                        <button class="btn-bloquear">Bloquear Posici√≥n</button>
                        <button class="btn-eliminar">Eliminar</button>
                    </div>
                `;

                diagrama.appendChild(nota);
                configurarEventosNota(nota);
                
                // Ajustar altura despu√©s de a√±adir contenido
                setTimeout(() => {
                    const contenido = nota.querySelector('.contenido-nota');
                    if (contenido) {
                        nota.style.height = Math.max(100, contenido.scrollHeight + 30) + 'px';
                    }
                }, 100);
                
                guardarLocal();
            }
            
            setTimeout(() => {
                ajustarCanvas();
                dibujarConexiones();
            }, 100);
        });

        window.addEventListener('beforeunload', guardarLocal);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                guardarLocal();
            }
        });

        // Prevenir zoom y men√∫ contextual
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('contextmenu', (e) => {
            if (isMobile) {
                e.preventDefault();
            }
        });

        // Optimizaci√≥n de redibujado
        let necesitaRedibujar = false;
        
        function marcarParaRedibujar() {
            if (!necesitaRedibujar) {
                necesitaRedibujar = true;
                requestAnimationFrame(dibujarConexionesOptimizado);
            }
        }

        function dibujarConexionesOptimizado() {
            necesitaRedibujar = false;
            dibujarConexiones();
        }

        const observer = new MutationObserver(() => {
            marcarParaRedibujar();
        });

        window.addEventListener('load', () => {
            observer.observe(diagrama, {
                attributes: true,
                subtree: true,
                attributeFilter: ['style']
            });
        });
    </script>
</body>
</html>
